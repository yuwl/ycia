<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.order.dao.OrdersDao">
    
	<sql id="ordersColumns">
		a.id AS "id",
		a.user_id AS "userId",
		a.agent_id AS "agentId",
		a.product_id AS "productId",
		a.office_id AS "officeId",
		a.order_no AS "orderNo",
		a.premium AS "premium",
		a.amount AS "amount",
		a.rate AS "rate",
		a.commission AS "commission",
		a.fee_rate AS "feeRate",
		a.fee AS "fee",
		a.status AS "status",
		a.insure_name AS "insureName",
		a.pay_time AS "payTime",
		a.create_time AS "createTime",
		a.update_time AS "updateTime",
		a.remarks AS "remarks",
		a.clent_id AS "clentId"
	</sql>
	
	<sql id="ordersJoins">
	</sql>
    
	<select id="get" resultType="Orders">
		SELECT 
			<include refid="ordersColumns"/>
		FROM orders a
		<include refid="ordersJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="Orders">
		SELECT 
			<include refid="ordersColumns"/>
		FROM orders a
		<include refid="ordersJoins"/>
		<where>
			
			<if test="id != null and id != ''">
				AND a.id = #{id}
			</if>
			<if test="userId != null and userId != ''">
				AND a.user_id = #{userId}
			</if>
			<if test="agentId != null and agentId != ''">
				AND a.agent_id = #{agentId}
			</if>
			<if test="productId != null and productId != ''">
				AND a.product_id = #{productId}
			</if>
			<if test="officeId != null and officeId != ''">
				AND a.office_id = #{officeId}
			</if>
			<if test="orderNo != null and orderNo != ''">
				AND a.order_no = #{orderNo}
			</if>
			<if test="premium != null and premium != ''">
				AND a.premium = #{premium}
			</if>
			<if test="amount != null and amount != ''">
				AND a.amount = #{amount}
			</if>
			<if test="rate != null and rate != ''">
				AND a.rate = #{rate}
			</if>
			<if test="commission != null and commission != ''">
				AND a.commission = #{commission}
			</if>
			<if test="feeRate != null and feeRate != ''">
				AND a.fee_rate = #{feeRate}
			</if>
			<if test="fee != null and fee != ''">
				AND a.fee = #{fee}
			</if>
			<if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			<if test="insureName != null and insureName != ''">
				AND a.insure_name = #{insureName}
			</if>
			<if test="payTime != null and payTime != ''">
				AND a.pay_time = #{payTime}
			</if>
			<if test="createTime != null and createTime != ''">
				AND a.create_time = #{createTime}
			</if>
			<if test="updateTime != null and updateTime != ''">
				AND a.update_time = #{updateTime}
			</if>
			<if test="remarks != null and remarks != ''">
				AND a.remarks = #{remarks}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY a.create_time DESC
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	<select id="findFinanceList" resultType="OrdersDto">
		SELECT 
		b.name AS agentName,
		GROUP_CONCAT(c.company_id) AS companyId,
			GROUP_CONCAT(	c.`status`) AS companyStatus,
			<include refid="ordersColumns"/>
		FROM orders a 
		LEFT JOIN order_company c ON c.order_id = a.id 
		LEFT JOIN agent b ON a.agent_id = b.id
		<include refid="ordersJoins"/>
		<where>
			
			<if test="id != null and id != ''">
				AND a.id = #{id}
			</if>
			<if test="userId != null and userId != ''">
				AND a.user_id = #{userId}
			</if>
			<if test="agentId != null and agentId != ''">
				AND a.agent_id IN (select age.id from agent age where age.name = #{agentId})
			</if>
			<if test="productId != null and productId != ''">
				AND a.product_id = #{productId}
			</if>
			<if test="officeId != null and officeId != ''">
				AND a.office_id = #{officeId}
			</if>
			<if test="orderNo != null and orderNo != ''">
				AND a.order_no = #{orderNo}
			</if>
			<if test="premium != null and premium != ''">
				AND a.premium = #{premium}
			</if>
			<if test="amount != null and amount != ''">
				AND a.amount = #{amount}
			</if>
			<if test="rate != null and rate != ''">
				AND a.rate = #{rate}
			</if>
			<if test="commission != null and commission != ''">
				AND a.commission = #{commission}
			</if>
			<if test="feeRate != null and feeRate != ''">
				AND a.fee_rate = #{feeRate}
			</if>
			<if test="fee != null and fee != ''">
				AND a.fee = #{fee}
			</if>
			<if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			<if test="insureName != null and insureName != ''">
				AND a.insure_name = #{insureName}
			</if>
			<if test="payTime != null and payTime != ''">
				AND a.pay_time = #{payTime}
			</if>
			<if test="createTime != null and createTime != ''">
				AND a.create_time = #{createTime}
			</if>
			<if test="updateTime != null and updateTime != ''">
				AND a.update_time = #{updateTime}
			</if>
			<if test="remarks != null and remarks != ''">
				AND a.remarks = #{remarks}
			</if>
		</where>
		GROUP BY a.id
		<choose>
			
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY a.create_time DESC
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="Orders">
		SELECT 
			<include refid="ordersColumns"/>
		FROM orders a
		<include refid="ordersJoins"/>
		<where>
			
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY a.create_time DESC
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO orders(
			id,
			user_id,
			agent_id,
			product_id,
			office_id,
			order_no,
			premium,
			amount,
			rate,
			commission,
			fee_rate,
			fee,
			status,
			insure_name,
			pay_time,
			create_time,
			update_time,
			remarks,
			clent_id
		) VALUES (
			#{id},
			#{userId},
			#{agentId},
			#{productId},
			#{officeId},
			#{orderNo},
			#{premium},
			#{amount},
			#{rate},
			#{commission},
			#{feeRate},
			#{fee},
			#{status},
			#{insureName},
			#{payTime},
			#{createTime},
			#{updateTime},
			#{remarks},
			#{clentId}
		)
	</insert>
	
	<update id="update">
		UPDATE orders SET 	
			user_id = #{userId},
			agent_id = #{agentId},
			product_id = #{productId},
			office_id = #{officeId},
			order_no = #{orderNo},
			premium = #{premium},
			amount = #{amount},
			rate = #{rate},
			commission = #{commission},
			fee_rate = #{feeRate},
			fee = #{fee},
			status = #{status},
			insure_name = #{insureName},
			pay_time = #{payTime},
			create_time = #{createTime},
			update_time = #{updateTime},
			remarks = #{remarks},
			clent_id = #{clentId}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		DELETE FROM orders
		WHERE id = #{id}
	</update>
	
	<!-- 自定义SQL -->
	<select id="findAddCompanyList" resultType="OrdersDto">
		SELECT
			a.*,
			GROUP_CONCAT(c.company_id) AS companyId,
			GROUP_CONCAT(	c.`status`) AS companyStatus
		FROM
			orders a
		LEFT JOIN order_company c ON c.order_id = a.id
		<where>
			<if test="agentId != null and agentId != ''">
				AND a.agent_id = #{agentId}
			</if>
			<if test="officeId != null and officeId != ''">
				AND a.office_id = #{officeId}
			</if>
			<if test="orderNo != null and orderNo != ''">
				AND a.order_no = #{orderNo}
			</if>
			<if test="insureName != null and insureName != ''">
				AND a.insure_name = #{insureName}
			</if>
			<if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			</where>
		GROUP BY a.id
		ORDER BY
			a.create_time DESC
	</select>
	
	<update id="updateOrderStatus">
		UPDATE orders
		<trim prefix="set" suffixOverrides=",">
			<if test="premium != null and premium != ''">premium = #{premium},</if>
			<if test="feeRate != null and feeRate != ''">fee_rate = #{feeRate},</if>
			<if test="status != null and status != ''">status = #{status},</if>
		</trim>			 	
		<where> order_no = #{orderNo}</where>
	</update>
</mapper>